<link href='http://fonts.googleapis.com/css?family=Hammersmith+One' rel='stylesheet' type='text/css'>
<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8" /><title>Home | 学到老，活到老</title>
<meta name="author" content="laszo">
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta property="og:site_name" content="">
<!--<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" type="text/css" />-->
<link rel="stylesheet" href="/css/bootstrap.css" type="text/css">
<link rel="stylesheet" href="/css/blog.css" type="text/css">
<link rel="stylesheet" href="/css/pygments.css" type="text/css">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script async="" type="text/javascript" src="//None.disqus.com/count.js"></script>

</head><header class="navbar navbar-default topnav" role="banner">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navigation">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/" id="logo">学到老，活到老</a>
        </div>
        <div class="collapse navbar-collapse" id="navigation">
            <ul class="nav navbar-nav navbar-left" id="nav">
                                                                <li><a class="blog-nav-item" href="/">Home</a></li>
                                                                                                <li><a class="blog-nav-item" href="/archives">Archives</a></li>
                                                                                                <li><a class="blog-nav-item" href="/categories">Categories</a></li>
                                                                                                <li><a class="blog-nav-item" href="/tags">Tags</a></li>
                                                                                                <li><a class="blog-nav-item" href="/about">About</a></li>
                                                                                                <li><a class="blog-nav-item" href="/rss.xml">RSS</a></li>
                                                            </ul>
            <ul class="nav navbar-nav navbar-right" id="nav">
                                                                    </ul>
        </div>
    </div>
</header><body>


<div class="container innerpage_content">
  <div class="row">

    <div class="col-lg-9 col-md-9 col-sm-9 col-xs-9">
            <div class="blog-post box">
        <h2 class="blog-post-title"><a href='/blog/2014/12/10/a-new-post/'>a new post</a></h2>
        <p class="blog-post-meta">Dec 10, 2014 by <i>laszo</i></p>
        
        <a href="/blog/2014/12/10/a-new-post/" >Read More</a>
      </div>

            <div class="blog-post box">
        <h2 class="blog-post-title"><a href='/blog/2014/12/10/zhe-ji-tian-blog-huai-le/'>这几天博客有问题</a></h2>
        <p class="blog-post-meta">Dec 10, 2014 by <i>user</i></p>
        <p>使用crotal制作博客，markdown文件中的 slug 一项，在generate过程中，有可能会作为文件名或目录名使用，所以最好不要使用特殊字符，最多使用下划线和短横线。否则生成会有问题。</p>
        <a href="/blog/2014/12/10/zhe-ji-tian-blog-huai-le/" >Read More</a>
      </div>

            <div class="blog-post box">
        <h2 class="blog-post-title"><a href='/blog/2014/11/22/query-chat-logs-anothor-way-may-be-better/'>query chat logs: anothor way, may be better</a></h2>
        <p class="blog-post-meta">Nov 22, 2014 by <i>user</i></p>
        <p>this ariticle : <a href="http://www.lvxiaoyu.com/blog/2014/11/13/openfire-ke-hu-duan-huo-qu-liao-tian-ji-lu/">openfire客户端获取聊天记录</a> maybe is not nessary.</p>
<p>see this: (http://stackoverflow.com/questions/11397172/xmppframework-retrieve-archived-messages-from-openfire-server?lq=1)</p>
<p>may be it is the better and earier way.</p>
<p>just send a <retrieve> package, you will receive a list of chat log. see doc : (http://xmpp.org/extensions/xep-0136.html). I have not tried, which will be my work on monday(11.24)</p>
        <a href="/blog/2014/11/22/query-chat-logs-anothor-way-may-be-better/" >Read More</a>
      </div>

            <div class="blog-post box">
        <h2 class="blog-post-title"><a href='/blog/2014/11/20/app-im-solution-provider-in-cn/'>总结国内的移动即时通讯解决方案提供商--标题还得改改</a></h2>
        <p class="blog-post-meta">Nov 20, 2014 by <i>user</i></p>
        <p>环信：http://www.easemob.com/
亲加通信云：http://www.gotye.com.cn/</p>
        <a href="/blog/2014/11/20/app-im-solution-provider-in-cn/" >Read More</a>
      </div>

            <div class="blog-post box">
        <h2 class="blog-post-title"><a href='/blog/2014/11/13/openfire-ke-hu-duan-huo-qu-liao-tian-ji-lu/'>openfire客户端获取聊天记录</a></h2>
        <p class="blog-post-meta">Nov 13, 2014 by <i>user</i></p>
        <p>openfire是当前较为流行的xmpp服务端。使用它作为服务端，借助github上面的一些开源项目，很容易打造出一套跨平台的即时通讯解决方案，包含如下的五个主流平台：PC端的windows、mac os、linux，以及移动端的ios和android平台。</p>
<p>当然，这只能包含最基本的通讯功能。如果想达到QQ、MSN、微信、whatsapp这样主流软件丰富的用户体验，还有许多工作要做。</p>
<p>比如，如何在服务端保存聊天记录，并需要的时候客户端能够获取并展现出来，就需要专门研究一下。</p>
<p>这篇<a href="https://community.igniterealtime.org/thread/29686">Openfire Chat Logs</a>居然是google搜出来的第一篇。</p>
<div class="codehilite"><pre><span class="n">On</span> <span class="n">the</span> <span class="n">server</span><span class="o">-</span><span class="n">side</span> <span class="n">it</span> <span class="n">is</span> <span class="n">configured</span> <span class="n">from</span> <span class="n">the</span> <span class="s">&quot;Message Audit Policy&quot;</span> <span class="n">link</span><span class="o">/</span><span class="n">page</span><span class="p">.</span>
</pre></div>


<p>问题：</p>
<ol>
<li>Message Audit Policy 是否需要装插件？答案：不需要，就在server-server settings页面里。</li>
<li>这样记录应该不是聊天记录吧？仅仅是记录了所有的通讯数据包。不方便根据用户或房间查询聊天记录。答案：不方便。需要一个viewer，有人建议看这篇帖子(<a href="https://community.igniterealtime.org/thread/29159">audit log viewer?</a>)。</li>
<li>即便是能看了，也并未提供一个接口，使客户端用以获取与某项的聊天记录。</li>
</ol>
<p>从这篇的问答里我追踪到了<a href="https://community.igniterealtime.org/docs/DOC-1041">Non-Jive Openfire Plugins</a>。然后<a href="http://sourceforge.net/projects/iball-auditor/">i-Ball Chat Auditor</a> 装了一下居然不起作用。如何让它起作用以及如何使用它，留待以后研究了。</p>
<p><a href="https://community.igniterealtime.org/thread/14773">Logging Conversations</a>这篇帖子很老（2006年），也很长。另有：<a href="http://www.xmpp.org/extensions/xep-0136.html">XEP-0136: Message Archiving</a>乃是最权威的资料。</p>
<p>从stackoverflow的一个问题<a href="http://stackoverflow.com/questions/6635034/smack-api-read-chat-histroy-from-openfire-server">Smack API - Read Chat Histroy from Openfire Server</a>中，
<a href="http://stackoverflow.com/users/1206536/alpay">Alpay</a>提供了一个回答，这个回答并没有帮助到我，而回答下面的评论（comments）里面，被折叠的一条评论倒是帮助到了我：</p>
<blockquote>
<p>I haven' t tested but you should see <a href="http://www.igniterealtime.org/projects/openfire/plugins/monitoring/readme.html">this</a>, and <a href="https://blogs.reucon.com/srt/tag/open_archive/">this</a>. I hope they help –  Alpay Feb 7 '13 at 12:40</p>
</blockquote>
<p>从这里发现，原来<a href="http://www.igniterealtime.org/projects/openfire/plugins/monitoring/readme.html">Monitoring Service</a>插件就是用于记录聊天记录（chat logs）的。但是有两个问题：</p>
<ol>
<li>如何从客户端获取这些聊天记录呢？</li>
<li>中文的信息是乱码该如何解决？</li>
</ol>
<p>根据这篇<a href="http://www.myexception.cn/java-other/1001465.html">spark + openfire的聊天监控问题</a>，检查了mysql数据库，发现的确有一张ofMessageArchive表。</p>
<div class="codehilite"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">ofMessageArchive</span> <span class="n">limit</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>


<p>可以看到聊天数据的确存在，那么现在有两项工作要做：</p>
<ol>
<li>解决中文乱码问题。顺便解决用户昵称中文乱码。</li>
<li>写一个小型服务端，提供rest接口，根据fromJID、toJID、sentDate、分页等信息，供客户端查询聊天记录。</li>
</ol>
<p>按照这篇<a href="http://blog.sina.com.cn/s/blog_4bf75d0a0100l92b.html">解决openfire在使用MySQL数据库后的中文乱码问题</a>，在serverURL这一节添加如下字符：</p>
<div class="codehilite"><pre><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">useUnicode</span><span class="o">=</span><span class="nb">true</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">characterEncoding</span><span class="o">=</span><span class="n">utf8</span>
</pre></div>


<p>之后重启openfire。使用spark发送了几天中英文及数字消息，发现现在不记录中文消息。以前是记录，但显示为问号，现在是不记录。</p>
<p>似乎可以考虑重新安装mysql和openfire了。先在vmware虚拟机上试验一下搞了utf8以后能否支持中文昵称和中文聊天记录。官方文档：<a href="http://www.igniterealtime.org/builds/openfire/docs/latest/documentation/database.html">Database Installation Guide</a>。最关键的两个配置：</p>
<div class="codehilite"><pre><span class="nb">create</span> <span class="nx">database</span> <span class="nx">openfire</span> <span class="nb">default</span> <span class="nx">character</span> <span class="nb">set</span> <span class="nx">utf8</span> <span class="nb">default</span> <span class="nx">collate</span> <span class="nx">utf8_general_ci</span>

<span class="o">&lt;</span><span class="nx">serverURL</span><span class="o">&gt;</span><span class="nx">jdbc</span><span class="p">:</span><span class="nx">mysql</span><span class="p">:</span><span class="c1">//localhost:3306/openfire1?rewriteBatchedStatements=true&amp;amp;useUnicode=true&amp;amp;characterEncoding=UTF-8&amp;amp;characterSetResults=UTF-8&lt;/serverURL&gt;</span>
</pre></div>


<p>经过一番折腾，终于可以在ofMessageArchive这个表里看到中文聊天记录了。剩下的工作就是写一个rest服务端，提供客户端对于聊天记录的查询。只是包装一些简单的sql查询、或者使用ORM库，在这里就不赘述了。</p>
<p>那么刚才提到的Message Audit Policy就可以禁用掉了。Message Audit Policy与Monitoring Service 的关系、特点、异同、适用性，留待以后去探究了。或者，如果读者你对着这方面有要说的，欢迎分享给大家。</p>
        <a href="/blog/2014/11/13/openfire-ke-hu-duan-huo-qu-liao-tian-ji-lu/" >Read More</a>
      </div>

                <br/>
    <ul class="page_numbers pull-right">
                <li class="page_info"><p>Page 1 of 12</p></li>
                                                <li class="active"><a>1<span class="sr-only">(current)</span></a></li>
                                                            <li><a href="/blog/page/2">2</a></li>
                                                            <li><a href="/blog/page/3">3</a></li>
                                                            <li><a href="/blog/page/4">4</a></li>
                                                            <li><a href="/blog/page/5">5</a></li>
                                                            <li><a href="/blog/page/6">6</a></li>
                                                            <li><a href="/blog/page/7">7</a></li>
                                                            <li><a href="/blog/page/8">8</a></li>
                                                            <li><a href="/blog/page/9">9</a></li>
                                                            <li><a href="/blog/page/10">10</a></li>
                                                            <li><a href="/blog/page/11">11</a></li>
                                                            <li><a href="/blog/page/12">12</a></li>
                                        </ul>
    </div>

<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12 right">
            <div class="widget box">
    <h4 class="widgettitle">About</h4>
    <div class="description">
        <p>A static site generator which is written in Python, super fast, easy to use, and free to all.Start a blog right now using Crotal!</p>
    </div>
</div>            <div class="widget recent_posts box">
    <h4 class="widgettitle">Recent Posts</h4>
    <ul>
                <li><a href="/blog/2014/12/10/a-new-post/">a new post</a></li>
                <li><a href="/blog/2014/12/10/zhe-ji-tian-blog-huai-le/">这几天博客有问题</a></li>
                <li><a href="/blog/2014/11/22/query-chat-logs-anothor-way-may-be-better/">query chat logs: anothor way, may be better</a></li>
                <li><a href="/blog/2014/11/20/app-im-solution-provider-in-cn/">总结国内的移动即时通讯解决方案提供商--标题还得改改</a></li>
                <li><a href="/blog/2014/11/13/openfire-ke-hu-duan-huo-qu-liao-tian-ji-lu/">openfire客户端获取聊天记录</a></li>
            </ul>
</div>    </div>
  </div>
</div>
<div class="blog-footer">
<p id="copyright">&copy; 2013 laszo | Powered by <a href="http://crotal.org" target="_blank">Crotal</a></p>
    </div>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
<!--
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/colorbrewer.v1.min.js"></script>
<script src="/js/trianglify.js"></script>
<script type="text/javascript" charset="utf-8">
        var t = new Trianglify({
        x_gradient: colorbrewer.Blues[9],
        y_gradient: colorbrewer.Blues[9],
        noiseIntensity: 0
        });

        redraw();

        function redraw() {
            console.log("drawing "+document.body.clientWidth+"x"+height())
            var pattern = t.generate(document.body.clientWidth, height());
            document.body.setAttribute('style', 'background-image: '+pattern.dataUrl);
            saveas.setAttribute('href', pattern.dataUri);
            noise_display.innerHTML = t.options.noiseIntensity.toFixed(1);
            cellsize_display.innerHTML = t.options.cellsize.toFixed(0);
            cellpadding_display.innerHTML = t.options.cellpadding.toFixed(0);
        };

        function recolor() {
            t.options.x_gradient = Trianglify.randomColor();
            t.options.y_gradient = t.options.x_gradient.map(function(c){return d3.rgb(c).brighter(.5)});
        }

        function noise(i) {
            i += t.options.noiseIntensity;
            if (i >= 0 && i <= 1) {
                t.options.noiseIntensity = i;
                redraw();
            } else if (i < 0) {
                t.options.noiseIntensity = 0;
                redraw();
            }
        }

        function cellsize(i) {
            i += t.options.cellsize;
            if (i >= 0) {
                t.options.cellsize = i;
                t.options.bleed = i;
                if (t.options.cellpadding >= t.options.cellsize/2) {
                    t.options.cellpadding = 5*Math.floor((t.options.cellsize/2 - 1)/5);
                }
                redraw();
            }
        }

        function cellpadding(i) {
            i += t.options.cellpadding;
            if (i >= 0  && i < t.options.cellsize/2) {
                t.options.cellpadding = i;
                redraw();
            }
        }

        function height() {
            return Math.max(
                document.body.scrollHeight, document.documentElement.scrollHeight,
                document.body.offsetHeight, document.documentElement.offsetHeight,
                document.body.clientHeight, document.documentElement.clientHeight
            );
        }

        function toggleClass(el, className) {
            if (el.classList) {
              return el.classList.toggle(className);
            } else {
              var classes = el.className.split(' ');
              var existingIndex = classes.indexOf(className);

              if (existingIndex >= 0)
                classes.splice(existingIndex, 1);
              else
                classes.push(className);

              el.className = classes.join(' ');
              return existingIndex >= 0;
            }
        }
        // analytics
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-40241848-1', 'qrohlf.com');
        ga('send', 'pageview');
        </script>
-->




</body>
</html>