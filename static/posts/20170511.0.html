<html>

<head>
    <meta charset="utf-8">
    <title>Python中的Web和WSGI的各组件总结 - Lv Xiaoyu `Site</title>
    <link rel="stylesheet" href="../../static/css/bootstrap.min.css?v=1" />
    <link rel="stylesheet" href="../../static/css/mp.css?v=1" />
    <link rel="stylesheet" href="../../static/css/codehilite.css?v=1" />
</head>

<body>
    <div class="container">
        <div class="blog-header">
            <a href="../../index.html">
                <h1>Lv Xiaoyu `Site</h1>
            </a>
        </div>

        <div class="col-sm-9">
            <h3 class="blog-post-title">Python中的Web和WSGI的各组件总结</h3>

            <div class="post-content">
                <p>通过[WSGI的Server端分析]和[RequestHandler分析]这两篇文章，我们基本了解了Python Web服务中涉及到的各个组件。现在从最基本的开始，我们总结出来其中的要点：</p>
<ol>
<li>
<p>Web的基本模式，客户端 &lt; —— &gt; 服务端模型。服务端持续运行，监听请求。客户端向服务端发送请求，服务端处理请求，向服务端发送响应。</p>
</li>
<li>
<p>在服务端，又分为Server和Handler两类对象，简称为服务类和处理类。两种对象协同工作，共同完成对请求的响应。</p>
</li>
<li>
<p>服务类负责如下工作：</p>
<ol>
<li>初始化环境配置</li>
<li>监听请求</li>
<li>将请求传递给处理类</li>
</ol>
</li>
<li>
<p>处理类接收请求，处理，返回响应。通过服务类返回响应给服务端。</p>
</li>
<li>
<p>在WSGI规范下，服务类接收一个application对象，在传递请求时将这个对象也传递给处理类，由application对象进行具体的处理，并把结果返回给处理类。</p>
</li>
</ol>
<p>下面来看看在Python标准库的具体实现上的关键点。</p>
<h4>SocketServer模块</h4>
<ol>
<li>
<p>BaseServer层面</p>
<ul>
<li>BaseServer是最基本的服务类，提供了基本的服务端处理流程框架，但没有实现任何具体过程。它的流程框架中最关键的一点是，持续监听、接收请求、调用处理类处理请求。</li>
<li>BaseRequestHandler，提供了基本的处理类逻辑框架，没有实现任何具体过程。处理逻辑中最关键的一点是在自身的构造方法中调用了自身的handle方法。</li>
</ul>
</li>
<li>
<p>TCPServer层面</p>
<ul>
<li>TCPServer提供了服务端在传输层的实现，具体来说就是创建和持有socket对象，使用该对象实现具体过程，这些过程包括：服务端的绑定、激活、获取请求、关闭请求、关闭服务端等。</li>
<li>StreamRequestHandler，最重要的工作是使用rfile和wfile简化了服务端与客户端的通信。</li>
</ul>
</li>
</ol>
<h4>BaseHTTPServer模块</h4>
<ol>
<li>HTTPServer继承自TCPServer，只覆写了父类的server_bound方法</li>
<li>BaseHTTPRequestHandler继承自StreamRequestHandler，提供如下逻辑：<ul>
<li>获取请求，通过上面提到的rfile</li>
<li>解析请求，保存各种请求的参数</li>
<li>提供根据请求的参数调用相应的方法，但不提供该方法的实现</li>
</ul>
</li>
</ol>
<h4>wsgiref模块</h4>
<p>这个模块主要提供WSGI规范的支持，相对于HTTPServer，主要增加了environment和application的概念，具体规范参看PEP333.</p>
<ol>
<li>
<p>WSGIServer继承自HTTPServer，有如下改进：</p>
<ol>
<li>覆写了server_bound</li>
<li>添加了setup_environ方法</li>
<li>添加了get_app和set_app方法</li>
</ol>
</li>
<li>
<p>WSGIRequestHandler继承自BaseHTTPRequestHandler，覆写了handle方法，该方法的核心逻辑是初始化了一个ServerHandler类，然后调用这个类的实例的run方法。</p>
</li>
<li>
<p>ServerHandler继承自SimpleHandler，注意它与上面提到其他模块中的各种RequestHandler不是一个继承体系。</p>
</li>
<li>
<p>SimpleHandler继承自BaseHandler。这类的主要工作是对stdin、stdout等输入输出源进行了重新定位。</p>
</li>
<li>
<p>BaseHandler提供了下面三个重要方法：</p>
<ol>
<li>run：负责配置环境、调用application、调用finish_response</li>
<li>start_response：本质上是一个write方法，用于向客户端发送数据，主要是发送HTTP头</li>
<li>finish_response：负责把application的运行结果（即所谓的“响应”）发送到客户端</li>
</ol>
</li>
</ol>
<p>通过如上的一套体系，再加上我们自己写的WSGI application，就提供了一套完整的web服务端。</p>
<p>把以上所有总结的要点结合起来，我们不妨自己写一个最简单的Server和Handler，两种对象中的每个方法采用标准库中类似方法的命名，取消了继承体系，只提供最直接的逻辑：</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">class</span> <span class="nc">Hanlder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">application</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s1">&#39;wb&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">items</span><span class="p">())</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_request</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_response</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="mi">65537</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Server</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">Hanlder</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">need_close</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fileno</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">need_close</span><span class="p">:</span>
                <span class="n">rl</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">el</span> <span class="o">=</span> <span class="n">_eintr_retry</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">rl</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handle_request</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_server</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_eintr_retry</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">select</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                <span class="k">raise</span>

<span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="s1">&#39;hello, world.&#39;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">9000</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
            </div>
        </div>
        <div class="col-md-3" role="complementary">
            <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix">
                
                <ul class="nav bs-docs-sidenav">
                    
                </ul>              
            </nav>
        </div>
    </div>
</body>

</html>