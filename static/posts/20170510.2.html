<html>
<head>
    <meta charset="utf-8">
    <title>对WSGI environ的分析 - Lv Xiaoyu `Site</title>
    <link rel="stylesheet" href="../../static/css/bootstrap.min.css?v=1" />
    <link rel="stylesheet" href="../../static/css/mp.css?v=1" />
    <link rel="stylesheet" href="../../static/css/codehilite.css?v=1" />
</head>
<body>
    <div class="container">
        <div class="blog-header">
            <a href="../../index.html"><h1>Lv Xiaoyu `Site</h1></a>
        </div>

        <h3 class="blog-post-title">对WSGI environ的分析</h3>

        <div class="post-content">
            <p>来看wsgiref库的BaseHandler：</p>
<div class="codehilite"><pre><span></span>def run(self, application):
    try:
        self.setup_environ()
    ...

def setup_environ(self):
    &quot;&quot;&quot;Set up the environment for one request&quot;&quot;&quot;

    env = self.environ = self.os_environ.copy()
    self.add_cgi_vars()

    env[&#39;wsgi.input&#39;]        = self.get_stdin()
    env[&#39;wsgi.errors&#39;]       = self.get_stderr()
    env[&#39;wsgi.version&#39;]      = self.wsgi_version
    env[&#39;wsgi.run_once&#39;]     = self.wsgi_run_once
    env[&#39;wsgi.url_scheme&#39;]   = self.get_scheme()
    env[&#39;wsgi.multithread&#39;]  = self.wsgi_multithread
    env[&#39;wsgi.multiprocess&#39;] = self.wsgi_multiprocess

    if self.wsgi_file_wrapper is not None:
        env[&#39;wsgi.file_wrapper&#39;] = self.wsgi_file_wrapper

    if self.origin_server and self.server_software:
        env.setdefault(&#39;SERVER_SOFTWARE&#39;,self.server_software)
</pre></div>


<p>注意，在每次调用run函数的时候都会调用一次setup_environ，进行环境变量设置，首先：</p>
<div class="codehilite"><pre><span></span>env = self.environ = self.os_environ.copy()
</pre></div>


<p>这句代码保证了environ被重新赋值，上一次处理请求所使用的environ不会被复用到下一次请求处理。而os_environ则来自操作系统的环境变量：</p>
<div class="codehilite"><pre><span></span>os_environ = dict(os.environ.items())
</pre></div>
        </div>
    </div>
</body>
</html>