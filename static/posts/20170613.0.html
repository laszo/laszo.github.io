<html>

<head>
    <meta charset="utf-8">
    <title>从Tornado源码追踪ioloop的实现 - Lv Xiaoyu `Site</title>
    <link rel="stylesheet" href="../../static/css/bootstrap.min.css?v=1" />
    <link rel="stylesheet" href="../../static/css/mp.css?v=1" />
    <link rel="stylesheet" href="../../static/css/codehilite.css?v=1" />
</head>

<body>
    <div class="container">
        <div class="blog-header">
            <a href="../../index.html">
                <h1>Lv Xiaoyu `Site</h1>
            </a>
        </div>

        <div class="col-sm-9">
            <h3 class="blog-post-title">从Tornado源码追踪ioloop的实现</h3>

            <div class="post-content">
                <p>tornado官网的demo：</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">tornado.ioloop</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Hello, world&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_app</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">([</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">),</span>
    <span class="p">])</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">make_app</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>如果是第一次接触，会对这一句</p>
<div class="codehilite"><pre><span></span>tornado.ioloop.IOLoop.current().start()
</pre></div>


<p>感到不明觉厉，今天就来八一八。</p>
<h4 id='socket_io'>socket的IO</h4>

<p>IOLoop用来处理非阻塞的socket的IO事件，关于socket的io可参看以前的文章，这里简要说明一下。
下面这样的代码可以看作是直接使用socket构建的一个最简单的服务端程序：</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">socket</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">c</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
    <span class="k">print</span> <span class="s1">&#39;Connected from &#39;</span><span class="p">,</span> <span class="n">a</span>
    <span class="n">c</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">65536</span><span class="p">)</span>
    <span class="c1"># do something</span>
    <span class="n">c</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<p>上面的代码，在没有接到客户端连接时，Python的进程会阻塞在<code>s.accept()</code>这一句上，每当有客户端连接时，接受数据并返回hello。如果接受了第一个客户端请求，正在处理的过程中，第二个客户端也连接过来了，只有等待服务端处理完第一个客户端的请求之后，才能处理第二个请求。每次只能处理一个请求，这样的服务器用处并不大。</p>
<p>为了解决这样的问题，现代操作系统提供了IO的多路复用（multiplexing）技术，有如下几种：</p>
<ul>
<li>select：支持所有的操作系统</li>
<li>poll：支持很多系统，但不包括windows</li>
<li>epoll：只支持Linux 2.5.44以上</li>
<li>kqueue：只支持BSD系统</li>
</ul>
<p>看ioloop的文档也有类似的描述：如果可以的话，我们在Linux上使用epoll、在BSD和Mac OS X上使用kqueue，否则就使用select。</p>
<h4 id='api'>API</h4>

<p>看到<code>IOLoop.current()</code>就知道，IOLoop通常使用单例对象，它有如下方法：</p>
<ul>
<li>start</li>
<li>stop</li>
<li>close</li>
<li>run_sync</li>
<li>current</li>
<li>make_current</li>
<li>instance</li>
<li>initialized</li>
</ul>
<p>IO事件：</p>
<ul>
<li>add_handler</li>
<li>update_handler</li>
<li>remove_handler</li>
</ul>
<p>这三个方法是使用IOLoop管理IO事件的主要方式，add_handler的参数：</p>
<div class="codehilite"><pre><span></span>IOLoop.add_handler(fd, handler, events)
</pre></div>


<p>其中events有三种值：</p>
<ul>
<li>fd是文件描述符</li>
<li>handler是一个callable对象</li>
<li>events有三种值：IOLoop.READ、IOLoop.WRITE、IOLoop.ERROR</li>
</ul>
<p>当events发生时，会调用：</p>
<div class="codehilite"><pre><span></span>handler(fd, events)
</pre></div>


<p>乍一看与select、epoll等原理差不多，只是更方便了，事实也的确是这样，IOLoop的目的本来就是：</p>
<ol>
<li>尽量使用当前平台最高效的方式来处理IO事件，能够管理大量的文件描述符</li>
<li>封装IO事件的监听逻辑，提供API使得能够方便的监听和处理IO</li>
</ol>
<p>回调与超时：</p>
<ul>
<li>add_callback</li>
<li>add_callback_from_signal</li>
<li>add_future</li>
<li>add_timeout</li>
<li>call_at</li>
<li>call_later</li>
<li>remove_timeout</li>
<li>spawn_callback</li>
<li>time</li>
</ul>
<h4 id='source_code'>源码</h4>

<p>首先来看tornado项目的文件结构，下面列出了今天会涉及到的几个文件：</p>
<div class="codehilite"><pre><span></span>tornado
|
|----platform
|    |
|    |----select.py
|    |----kqueue.py
|    |----epoll.py
|
|----ioloop.py
</pre></div>


<p>tornado的根目录下有ioloop.py，即所谓的tornado.ioloop模块。     </p>
            </div>
        </div>
        <div class="col-md-3" role="complementary">
            <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix">
                
                <h3>目录</h3>
                
                <ul class="nav bs-docs-sidenav">
                    
                    <li class="">
                        <a href="#socket_io">socket的IO</a>
                    </li>
                    <!--<li class="">
                        <a href="#download">下载</a>
                    </li>
                    <li class="">
                        <a href="#third-parties">对第三方组件的支持</a>
                    </li>
                    <li class="active">
                        <a href="#accessibility">可访问性</a>
                    </li>
                    <li>
                        <a href="#license-faqs">许可证 FAQ</a>
                    </li>
                    <li>
                        <a href="#translations">文档翻译</a>
                    </li>-->
                    
                    <li class="">
                        <a href="#api">API</a>
                    </li>
                    <!--<li class="">
                        <a href="#download">下载</a>
                    </li>
                    <li class="">
                        <a href="#third-parties">对第三方组件的支持</a>
                    </li>
                    <li class="active">
                        <a href="#accessibility">可访问性</a>
                    </li>
                    <li>
                        <a href="#license-faqs">许可证 FAQ</a>
                    </li>
                    <li>
                        <a href="#translations">文档翻译</a>
                    </li>-->
                    
                    <li class="">
                        <a href="#source_code">源码</a>
                    </li>
                    <!--<li class="">
                        <a href="#download">下载</a>
                    </li>
                    <li class="">
                        <a href="#third-parties">对第三方组件的支持</a>
                    </li>
                    <li class="active">
                        <a href="#accessibility">可访问性</a>
                    </li>
                    <li>
                        <a href="#license-faqs">许可证 FAQ</a>
                    </li>
                    <li>
                        <a href="#translations">文档翻译</a>
                    </li>-->
                    
                </ul>              
            </nav>
        </div>
    </div>
</body>

</html>